<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loading Cricket Hub...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
      /* --- Ad Placeholder Styles --- */
      /* By default, ad placeholders are not visible to users. */
      /* To enable them for layout testing, change "display: none" to "display: flex". */
      .ad-placeholder {
        display: none;
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'primary': '#1D4ED8',
              'secondary': '#1E3A8A',
              'accent': '#3B82F6',
              'neutral': '#1F2937',
              'base-100': '#F9FAFB',
              'info': '#0EA5E9',
              'success': '#10B981',
              'warning': '#F59E0B',
              'error': '#EF4444',
            }
          }
        }
      }
    </script>
    <script type="importmap">
{
  "imports": {
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-router-dom": "https://aistudiocdn.com/react-router-dom@^7.9.5"
  }
}
</script>
    <script src="https://unpkg.com/@babel/standalone@7.24.7/babel.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  </head>
  <body class="bg-base-100 text-neutral">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
import React, { useState, useEffect, useCallback, useRef } from 'react';
import ReactDOM from 'react-dom/client';
import { HashRouter, Routes, Route, Outlet, Link, NavLink, useParams, useNavigate } from 'react-router-dom';

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, getDocs, getDoc, addDoc, updateDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

// --- Firebase Config & Initialization ---
const firebaseConfig = {
  apiKey: "AIzaSyAKwOw7H40psr-DrGpaZaNmNJK9jRxhNLU",
  authDomain: "crickethub-1c169.firebaseapp.com",
  projectId: "crickethub-1c169",
  storageBucket: "crickethub-1c169.appspot.com",
  messagingSenderId: "377931902841",
  appId: "1:377931902841:web:f228dbaf437e426f8149a8",
  measurementId: "G-422P4QG1NB"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const postsCollectionRef = collection(db, 'posts');

// --- SEO Helper Functions ---
const setMetaTag = (attr, attrValue, content) => {
    const head = document.head;
    let element = head.querySelector(`meta[${attr}="${attrValue}"]`);
    if (!element) {
        element = document.createElement('meta');
        element.setAttribute(attr, attrValue);
        head.appendChild(element);
    }
    element.setAttribute('content', content);
};

const setLinkTag = (rel, href) => {
    const head = document.head;
    let element = head.querySelector(`link[rel="${rel}"]`);
    if (!element) {
        element = document.createElement('link');
        element.setAttribute('rel', rel);
        head.appendChild(element);
    }
    element.setAttribute('href', href);
};

const setStructuredData = (data) => {
    const head = document.head;
    let element = head.querySelector('script[type="application/ld+json"]');
    if (!element) {
        element = document.createElement('script');
        element.setAttribute('type', 'application/ld+json');
        head.appendChild(element);
    }
    element.textContent = JSON.stringify(data);
};

const removeMetaTagByAttr = (attr, attrValue) => {
    const element = document.head.querySelector(`meta[${attr}="${attrValue}"]`);
    if (element) element.remove();
};

const removeStructuredData = () => {
    const element = document.head.querySelector('script[type="application/ld+json"]');
    if (element) element.remove();
};

// --- Blog Service (Firebase Implementation) ---
const getPosts = async () => {
    const q = query(postsCollectionRef, orderBy('date', 'desc'));
    const data = await getDocs(q);
    return data.docs.map(doc => ({ ...doc.data(), id: doc.id }));
};

const getPostById = async (id) => {
    const postDoc = doc(db, 'posts', id);
    const docSnap = await getDoc(postDoc);
    return docSnap.exists() ? { ...docSnap.data(), id: docSnap.id } : undefined;
};

const addPost = async (postData) => {
    const newPost = { ...postData, date: new Date().toISOString() };
    const docRef = await addDoc(postsCollectionRef, newPost);
    return { ...newPost, id: docRef.id };
};

const updatePost = async (id, postData) => {
    const postDoc = doc(db, 'posts', id);
    await updateDoc(postDoc, postData);
    return { ...postData, id };
};

const deletePost = async (id) => {
    const postDoc = doc(db, 'posts', id);
    await deleteDoc(postDoc);
    return true;
};


// --- Components ---
const AdPlaceholder = ({ label, width = '100%', height = '90px' }) => {
  // This component is hidden by default via CSS in the <head>.
  // To make it visible for development, find the ".ad-placeholder" rule 
  // and change "display: none" to "display: flex".
  return (
    <div
      className="ad-placeholder my-8 items-center justify-center bg-gray-200 border-2 border-dashed border-gray-400"
      style={{ width, minHeight: height }}
      aria-hidden="true" // Hide from screen readers as it's not visible
    >
      <span className="text-gray-500 font-medium">{label}</span>
    </div>
  );
};

const Header = () => {
  const activeLinkStyle = { color:'#3B82F6', textDecoration:'underline' };
  return (
    <header className="bg-neutral shadow-md sticky top-0 z-50">
      <div className="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between h-16 items-center">
        <Link to="/" className="text-2xl font-bold text-white hover:text-accent transition-colors">Cricket Hub</Link>
        <nav className="hidden md:flex items-center space-x-4">
          <NavLink to="/" className="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium" style={({isActive})=>isActive?activeLinkStyle:undefined}>Home</NavLink>
          <NavLink to="/about" className="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium" style={({isActive})=>isActive?activeLinkStyle:undefined}>About</NavLink>
        </nav>
      </div>
    </header>
  );
};

const Footer = () => (
    <footer className="bg-neutral text-white mt-auto">
        <div className="container mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center">
            <div className="flex justify-center space-x-6 mb-4">
                <Link to="/about" className="text-sm text-gray-400 hover:text-white">About Us</Link>
                <Link to="/contact" className="text-sm text-gray-400 hover:text-white">Contact Us</Link>
                <Link to="/privacy" className="text-sm text-gray-400 hover:text-white">Privacy Policy</Link>
            </div>
            <p>&copy; {new Date().getFullYear()} Cricket Hub. All rights reserved.</p>
        </div>
    </footer>
);

const PostCard = ({post})=>(
  <div className="bg-white rounded-lg shadow-lg overflow-hidden transform hover:-translate-y-1 transition-transform duration-300">
    <Link to={`/post/${post.id}`} className="block">
      <img className="w-full h-48 object-cover" src={post.imageUrl} alt={post.title} />
      <div className="p-6">
        <h2 className="text-2xl font-bold mb-2 text-neutral hover:text-primary">{post.title}</h2>
        <p className="text-gray-500 text-sm mb-4">By {post.author} on {new Date(post.date).toLocaleDateString()}</p>
        <p className="text-gray-700 leading-relaxed">{post.excerpt}</p>
      </div>
    </Link>
  </div>
);

const PostList = () => {
  const [posts,setPosts]=useState([]); const [loading,setLoading]=useState(true);
  useEffect(()=>{
    document.title = 'Cricket Hub - Latest Articles and News';
    setMetaTag('name', 'description', 'Your one-stop destination for the latest cricket news, articles, match analysis, and player insights. Stay updated with Cricket Hub.');
    setMetaTag('property', 'og:title', 'Cricket Hub - Latest Articles and News');
    setMetaTag('property', 'og:description', 'Your one-stop destination for the latest cricket news, articles, match analysis, and player insights.');
    setMetaTag('property', 'og:type', 'website');
    setMetaTag('property', 'og:url', window.location.origin);
    setMetaTag('property', 'og:image', 'https://picsum.photos/seed/crickethub/1200/630');
    setMetaTag('name', 'twitter:card', 'summary_large_image');
    setLinkTag('canonical', window.location.origin);
    removeStructuredData();
    removeMetaTagByAttr('name', 'robots'); // Ensure admin 'noindex' is removed

    const fetchPosts=async()=>{ setLoading(true); const data=await getPosts(); setPosts(data); setLoading(false); };
    fetchPosts();
  },[]);

  if(loading) return <div className="flex justify-center items-center h-64"><div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary"></div></div>;

  const postsWithAds = posts.reduce((acc, post, index) => {
    acc.push(<PostCard key={post.id} post={post}/>);
    // Insert an in-feed ad after the 3rd post, 6th, etc.
    if ((index + 1) % 3 === 0 && index < posts.length - 1) {
      acc.push(
        <div key={`ad-wrapper-${index}`} className="md:col-span-2 lg:col-span-3">
          <AdPlaceholder label={`In-feed Ad #${(index + 1) / 3}`} />
        </div>
      );
    }
    return acc;
  }, []);

  return (
    <div>
      <AdPlaceholder label="Homepage Top Banner" />
      <h1 className="text-4xl font-extrabold text-center mb-12 text-neutral">Latest Articles</h1>
      <div className="grid gap-8 md:grid-cols-2 lg:grid-cols-3">{postsWithAds}</div>
    </div>
  );
};

const PostDetail = () => {
  const {id}=useParams(); const [post,setPost]=useState(null); const [loading,setLoading]=useState(true);
  
  useEffect(()=>{
    if(id){
      const fetchPost=async()=>{ setLoading(true); const data=await getPostById(id); setPost(data || null); setLoading(false); };
      fetchPost();
    }
    return () => { removeStructuredData(); }; // Cleanup on unmount
  },[id]);

  useEffect(() => {
    if (post) {
      const postUrl = `${window.location.origin}/#/post/${post.id}`;
      document.title = `${post.title} | Cricket Hub`;
      setMetaTag('name', 'description', post.excerpt);
      setMetaTag('property', 'og:title', post.title);
      setMetaTag('property', 'og:description', post.excerpt);
      setMetaTag('property', 'og:type', 'article');
      setMetaTag('property', 'og:url', postUrl);
      setMetaTag('property', 'og:image', post.imageUrl);
      setMetaTag('name', 'twitter:card', 'summary_large_image');
      setLinkTag('canonical', postUrl);
      removeMetaTagByAttr('name', 'robots');

      setStructuredData({
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": post.title,
        "image": post.imageUrl,
        "datePublished": post.date,
        "author": {
          "@type": "Person",
          "name": post.author
        },
        "publisher": {
          "@type": "Organization",
          "name": "Cricket Hub",
          "logo": {
            "@type": "ImageObject",
            "url": "https://picsum.photos/seed/crickethub-logo/600/60"
          }
        },
        "description": post.excerpt
      });
    }
  }, [post]);

  if(loading) return <div className="flex justify-center items-center h-64"><div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary"></div></div>;
  
  if(!post) {
    document.title = 'Post Not Found | Cricket Hub';
    setMetaTag('name', 'robots', 'noindex');
    return <div className="text-center py-10"><h2 className="text-2xl font-bold">Post not found</h2><Link to="/" className="text-primary hover:underline mt-4 inline-block">Back to Home</Link></div>;
  }
  
  return (
    <article className="max-w-4xl mx-auto bg-white p-6 sm:p-8 lg:p-12 rounded-lg shadow-xl">
      <img className="w-full h-64 md:h-96 object-cover rounded-md mb-8" src={post.imageUrl} alt={post.title} />
      <h1 className="text-4xl md:text-5xl font-extrabold text-neutral mb-4 leading-tight">{post.title}</h1>
      <p className="text-gray-500 mb-8">By <span className="font-semibold">{post.author}</span> on {new Date(post.date).toLocaleDateString()}</p>
      
      <AdPlaceholder label="Article Top Banner" />

      <div className="prose lg:prose-xl max-w-none text-gray-800" dangerouslySetInnerHTML={{ __html: post.content }}></div>
      
      <AdPlaceholder label="Article Bottom Banner" />

      <div className="mt-12 border-t pt-8"><Link to="/" className="text-primary hover:text-secondary font-semibold transition-colors">&larr; Back to all articles</Link></div>
    </article>
  );
};

// --- Static Pages ---
const StaticPage = ({ title, children }) => {
    useEffect(() => {
        document.title = `${title} | Cricket Hub`;
        setMetaTag('name', 'robots', 'noindex, follow'); // Good for these pages
        return () => removeMetaTagByAttr('name', 'robots');
    }, [title]);

    return (
        <div className="max-w-4xl mx-auto bg-white p-6 sm:p-8 lg:p-12 rounded-lg shadow-xl">
            <h1 className="text-4xl font-extrabold text-neutral mb-6">{title}</h1>
            <div className="prose lg:prose-lg max-w-none text-gray-800">
                {children}
            </div>
        </div>
    );
};

const AboutPage = () => (
    <StaticPage title="About Us">
        <p>Welcome to Cricket Hub, your number one source for all things cricket. We're dedicated to giving you the very best of cricket news, with a focus on in-depth analysis, player statistics, and behind-the-scenes stories.</p>
        <p>Founded in {new Date().getFullYear()} by a passionate cricket fan, Cricket Hub has come a long way from its beginnings. When we first started out, our passion for the sport drove us to start our own blog.</p>
        <p>We hope you enjoy our articles as much as we enjoy offering them to you. If you have any questions or comments, please don't hesitate to contact us.</p>
        <p>Sincerely,</p>
        <p>The Cricket Hub Team</p>
    </StaticPage>
);

const ContactPage = () => (
    <StaticPage title="Contact Us">
        <p>We'd love to hear from you! Whether you have a question, a suggestion, or just want to talk about cricket, feel free to reach out.</p>
        <p>You can contact us via email at: <a href="mailto:contact@crickethub.co.in" className="text-primary hover:underline">contact@crickethub.co.in</a></p>
        <p>You can also follow us on our social media channels to stay updated with the latest content.</p>
        {/* Add social media links here when you have them */}
    </StaticPage>
);

const PrivacyPolicyPage = () => (
    <StaticPage title="Privacy Policy">
        <p>Your privacy is important to us. It is Cricket Hub's policy to respect your privacy regarding any information we may collect from you across our website, https://crickethub.co.in, and other sites we own and operate.</p>
        <p>We only ask for personal information when we truly need it to provide a service to you. We collect it by fair and lawful means, with your knowledge and consent. We also let you know why we’re collecting it and how it will be used.</p>
        <p>We only retain collected information for as long as necessary to provide you with your requested service. What data we store, we’ll protect within commercially acceptable means to prevent loss and theft, as well as unauthorized access, disclosure, copying, use or modification.</p>
        <p>We don’t share any personally identifying information publicly or with third-parties, except when required to by law.</p>
        <p>Our website may link to external sites that are not operated by us. Please be aware that we have no control over the content and practices of these sites, and cannot accept responsibility or liability for their respective privacy policies.</p>
        <p>Your continued use of our website will be regarded as acceptance of our practices around privacy and personal information. If you have any questions about how we handle user data and personal information, feel free to contact us.</p>
        <p>This policy is effective as of {new Date().toLocaleDateString()}.</p>
    </StaticPage>
);

// --- Admin Login ---
const AdminLogin = () => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [showLogin, setShowLogin] = useState(false);
  const [seq, setSeq] = useState('');
  const [loading, setLoading] = useState(false);
  
  useEffect(() => {
    document.title = 'Admin Login | Cricket Hub';
    setMetaTag('name', 'robots', 'noindex, nofollow');
  }, []);

  useEffect(()=>{
    if(showLogin) return;
    let timeoutId;
    const handleKeyDown=(e)=>{
      if(e.key.length>1){ setSeq(''); return; }
      const newSeq = (seq+e.key.toLowerCase()).slice(-10);
      setSeq(newSeq);
      if(newSeq==='cricadmin'){ setShowLogin(true); }
      clearTimeout(timeoutId);
      timeoutId=window.setTimeout(()=>setSeq(''),2000);
    };
    window.addEventListener('keydown',handleKeyDown);
    return ()=>{ window.removeEventListener('keydown',handleKeyDown); clearTimeout(timeoutId); };
  },[seq,showLogin]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    try {
      await signInWithEmailAndPassword(auth, email, password);
      // onAuthStateChanged in AdminLayout will handle the redirect
    } catch (err) {
      console.error(err);
      let friendlyError = "Failed to sign in. Please check your email and password.";
      if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
          friendlyError = "Invalid email or password.";
      } else if (err.code === 'auth/invalid-email') {
          friendlyError = "Please enter a valid email address.";
      }
      setError(friendlyError);
    } finally {
        setLoading(false);
    }
  };

  return showLogin?(
    <div className="min-h-screen flex items-center justify-center bg-gray-100">
      <div className="max-w-md w-full bg-white p-8 rounded-lg shadow-md">
        <h2 className="text-3xl font-bold text-center text-gray-900 mb-6">Admin Login</h2>
        <form onSubmit={handleSubmit}>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" value={email} onChange={e=>setEmail(e.target.value)} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm" autoFocus />
          </div>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">Password</label>
            <input type="password" value={password} onChange={e=>setPassword(e.target.value)} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm" />
          </div>
          {error && <p className="text-error text-sm mb-4">{error}</p>}
          <button type="submit" disabled={loading} className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-secondary disabled:bg-gray-400">
            {loading ? 'Logging in...' : 'Login'}
          </button>
        </form>
      </div>
    </div>
  ):(
    <div className="text-center text-gray-500">
      <h1 className="text-4xl font-bold mb-4">404</h1>
      <p className="text-xl">Page Not Found</p>
    </div>
  );
};

// --- Admin Layout & Dashboard ---
const AdminLayout = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    document.title = 'Admin Panel | Cricket Hub';
    setMetaTag('name', 'robots', 'noindex, nofollow');
  }, []);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      setLoading(false);
    });
    // Cleanup subscription on unmount
    return () => unsubscribe();
  }, []);

  const handleLogout = () => {
    signOut(auth).catch(error => console.error("Logout failed", error));
  };
  
  if (loading) {
    return (
      <div className="min-h-screen flex justify-center items-center">
        <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary"></div>
      </div>
    );
  }

  if (!user) {
    return <AdminLogin />;
  }

  return (
    <div className="min-h-screen bg-gray-100">
      <header className="bg-white shadow flex justify-between items-center px-4 sm:px-6 lg:px-8 py-4">
        <h1 className="text-2xl font-bold text-gray-900">Admin Panel</h1>
        <button onClick={handleLogout} className="bg-error text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">Logout</button>
      </header>
      <main className="container mx-auto px-4 sm:px-6 lg:px-8 py-8"><Outlet/></main>
    </div>
  );
};

const AdminDashboard = () => {
  const [posts,setPosts]=useState([]); const [loading,setLoading]=useState(true);
  const fetchPosts=useCallback(async()=>{ setLoading(true); const data=await getPosts(); setPosts(data); setLoading(false); },[]);
  useEffect(()=>{ fetchPosts(); },[fetchPosts]);
  const handleDelete=async(id)=>{ if(window.confirm('Are you sure you want to delete this post?')){ await deletePost(id); fetchPosts(); } };
  if(loading) return <p>Loading posts...</p>;
  return (
    <div className="bg-white p-8 rounded-lg shadow-md">
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-3xl font-bold">Manage Posts</h2>
        <Link to="/admin/new" className="bg-success text-white px-4 py-2 rounded-md hover:bg-green-700">+ New Post</Link>
      </div>
      <div className="overflow-x-auto">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Author</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
              <th className="relative px-6 py-3"><span className="sr-only">Actions</span></th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {posts.map(p=>(
              <tr key={p.id}>
                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{p.title}</td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{p.author}</td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{new Date(p.date).toLocaleDateString()}</td>
                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                  <Link to={`/admin/edit/${p.id}`} className="text-accent hover:text-secondary">Edit</Link>
                  <button onClick={()=>handleDelete(p.id)} className="text-error hover:text-red-700">Delete</button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

const PostEditor = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const [title, setTitle] = useState('');
  const [loading, setLoading] = useState(false);
  const isEditing = Boolean(id);
  const quillRef = useRef(null);
  const quillInstanceRef = useRef(null);

  useEffect(() => {
    if (quillRef.current && !quillInstanceRef.current) {
      quillInstanceRef.current = new Quill(quillRef.current, {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            ['blockquote', 'code-block'],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            ['link', 'image', 'video'],
            ['clean']
          ]
        },
        placeholder: 'Start writing your story here...',
      });
    }

    const quill = quillInstanceRef.current;
    if (quill) {
      if (isEditing) {
        setLoading(true);
        getPostById(id).then(post => {
          if (post) {
            setTitle(post.title || '');
            quill.root.innerHTML = post.content || '';
          }
        }).catch(err => {
          console.error(err);
        }).finally(() => {
          setLoading(false);
        });
      } else {
        setTitle('');
        quill.root.innerHTML = '';
      }
    }
  }, [id, isEditing]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!title.trim()) {
      alert('Title is required.');
      return;
    }
    setLoading(true);

    const finalContent = quillInstanceRef.current ? quillInstanceRef.current.root.innerHTML : '';
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = finalContent;
    const images = tempDiv.querySelectorAll('img');
    
    let firstImageUrl = null;
    if (images.length > 0) {
        firstImageUrl = images[0].src;
    }

    const textContent = tempDiv.textContent || "";
    const excerpt = textContent.substring(0, 150) + (textContent.length > 150 ? '...' : '');
    const imageUrl = firstImageUrl || `https://picsum.photos/seed/${title.trim().replace(/\s+/g, '-') || 'post'}/800/400`;

    const postData = {
      title,
      content: finalContent,
      author: 'Admin',
      excerpt,
      imageUrl,
    };

    try {
      if (isEditing) {
        await updatePost(id, postData);
      } else {
        await addPost(postData);
      }
      navigate('/admin');
    } catch (err) {
      console.error("Failed to save post:", err);
      let friendlyError = `An error occurred while saving the post. Please check your Firestore rules. Error: ${err.message}`;
      if (err.code === 'resource-exhausted' || (err.message && err.message.toLowerCase().includes('too large'))) {
          friendlyError = 'Failed to save post. The content, including images, is too large. Firestore documents have a 1MB size limit. Please try using smaller or fewer images.';
      }
      alert(friendlyError);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-lg shadow-md relative">
      {loading && isEditing && (
        <div className="absolute inset-0 bg-white bg-opacity-80 flex justify-center items-center z-10 rounded-lg">
          <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
        </div>
      )}
      <h2 className="text-3xl font-bold mb-6">{isEditing ? 'Edit Post' : 'Create New Post'}</h2>
      <form onSubmit={handleSubmit} className="space-y-6">
        <div>
          <label htmlFor="title-input" className="block text-sm font-medium text-gray-700">Title</label>
          <input
            id="title-input"
            type="text"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            required
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Content</label>
          <div ref={quillRef} style={{ height: '400px', backgroundColor: 'white' }} className="mt-1" />
        </div>
        <div className="flex justify-end">
          <button type="submit" disabled={loading} className="bg-primary text-white px-6 py-2 rounded-md hover:bg-secondary disabled:bg-gray-400 transition-colors">
            {loading ? 'Saving...' : (isEditing ? 'Update Post' : 'Publish Post')}
          </button>
        </div>
      </form>
    </div>
  );
};


// --- App ---
const App = () => (
  <HashRouter>
    <Header/>
    <div className="container mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow">
      <Routes>
        <Route path="/" element={<PostList/>}/>
        <Route path="/post/:id" element={<PostDetail/>}/>
        <Route path="/about" element={<AboutPage />} />
        <Route path="/contact" element={<ContactPage />} />
        <Route path="/privacy" element={<PrivacyPolicyPage />} />
        <Route path="/admin" element={<AdminLayout/>}>
          <Route index element={<AdminDashboard/>}/>
          <Route path="new" element={<PostEditor/>}/>
          <Route path="edit/:id" element={<PostEditor/>}/>
        </Route>
        <Route path="*" element={<div className="text-center py-20 text-gray-500"><h1 className="text-4xl font-bold mb-4">404</h1><p>Page Not Found</p></div>}/>
      </Routes>
    </div>
    <Footer/>
  </HashRouter>
);


const rootElem = document.getElementById('root');
const FlexRoot = () => <div className="flex flex-col min-h-screen"><App /></div>;
const root = ReactDOM.createRoot(rootElem);
root.render(<FlexRoot/>);
    </script>
  </body>
</html>